<div class="container-fluid">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h2 class="page-title">Task Analytics</h2>
      <div class="page-subtitle">Track your productivity and task progress</div>
    </div>
    <div class="d-flex align-items-center gap-3">
      <span class="text-muted small">Updated <span id="last-updated">just now</span></span>
      <select id="date-filter" class="form-select-glass">
        <option value="all" selected>All Time</option>
        <option value="week">Past Week</option>
        <option value="month">Past Month</option>
      </select>
    </div>
  </div>

  <!-- Key Stats Cards -->
  <div class="row g-4 mb-5">
    <!-- Total -->
    <div class="col-6 col-lg-3">
      <div class="glass-card stat-card primary h-100">
        <div class="icon-box">
          <i class="bi bi-layers-fill"></i>
        </div>
        <div class="stat-value" id="stat-total">â€”</div>
        <div class="stat-label">Total Tasks</div>
      </div>
    </div>
    <!-- Completed -->
    <div class="col-6 col-lg-3">
      <div class="glass-card stat-card success h-100">
        <div class="icon-box">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="stat-value" id="stat-completed">â€”</div>
        <div class="stat-label">Completed</div>
      </div>
    </div>
    <!-- Pending -->
    <div class="col-6 col-lg-3">
      <div class="glass-card stat-card warning h-100">
        <div class="icon-box">
          <i class="bi bi-clock-fill"></i>
        </div>
        <div class="stat-value" id="stat-pending">â€”</div>
        <div class="stat-label">Pending</div>
      </div>
    </div>
    <!-- Upcoming -->
    <div class="col-6 col-lg-3">
      <div class="glass-card stat-card h-100" style="background: rgba(99, 102, 241, 0.05);">
        <div class="icon-box" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">
          <i class="bi bi-calendar-event-fill"></i>
        </div>
        <div class="stat-value" id="stat-upcoming">â€”</div>
        <div class="stat-label">Upcoming</div>
      </div>
    </div>
  </div>

  <!-- Charts & Top Tasks -->
  <div class="row g-4">
    <!-- Status Distribution -->
    <div class="col-lg-4">
      <div class="glass-panel chart-container h-100">
        <div class="chart-title">
          Task Status
          <i class="bi bi-pie-chart-fill text-muted"></i>
        </div>
        <div style="height: 250px; position: relative;">
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Priority Breakdown -->
    <div class="col-lg-4">
      <div class="glass-panel chart-container h-100">
        <div class="chart-title">
          Priority Breakdown
          <i class="bi bi-bar-chart-fill text-muted"></i>
        </div>
        <div style="height: 250px; position: relative;">
          <canvas id="priorityChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Weekly Trend -->
    <div class="col-lg-4">
      <div class="glass-panel chart-container h-100">
        <div class="chart-title">
          Completion Trend
          <i class="bi bi-graph-up text-muted"></i>
        </div>
        <div style="height: 250px; position: relative;">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Priority List -->
  <div class="mt-4 mb-4">
    <div class="glass-panel p-4">
      <div class="chart-title mb-4">
        <span class="text-danger d-flex align-items-center gap-2">
          <i class="bi bi-exclamation-circle-fill"></i> Top Priority Pending
        </span>
      </div>
      <div id="top-tasks-list" class="d-flex flex-column gap-3">
        <!-- Tasks inserted via JS -->
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // -- Chart Globals --
  Chart.defaults.font.family = "'Outfit', sans-serif";
  Chart.defaults.color = '#64748b';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';

  let statusChart, priorityChart, trendChart;

  async function fetchAndRenderData() {
    const filter = document.getElementById('date-filter').value;
    document.getElementById('last-updated').innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    try {
      const res = await fetch(`/analytics/data?filter=${filter}`);
      if (!res.ok) throw new Error('API Error');
      const data = await res.json();

      // 1. Update Stats Cards (using new 'stats' object)
      const { total, completed, pending, upcoming } = data.stats;

      animateValue("stat-total", total);
      animateValue("stat-completed", completed);
      animateValue("stat-pending", pending);
      animateValue("stat-upcoming", upcoming);

      // 2. Charts
      const statusLabels = data.statusData.map(d => capitalize(d.status));
      const statusCounts = data.statusData.map(d => d.count);

      const priorityLabels = data.priorityData.map(d => capitalize(d.priority));
      const priorityCounts = data.priorityData.map(d => d.count);

      updateCharts(
        { labels: statusLabels, data: statusCounts },
        { labels: priorityLabels, data: priorityCounts },
        data.trendData
      );

      // 3. Top Tasks
      renderTopTasks(data.topPriorityTasks);

    } catch (e) {
      console.error(e);
      // alert('Could not load analytics data');
    }
  }

  function updateCharts(statusData, priorityData, trendData) {
    // Status Chart (Doughnut)
    if (statusChart) statusChart.destroy();
    statusChart = new Chart(document.getElementById('statusChart'), {
      type: 'doughnut',
      data: {
        labels: statusData.labels,
        datasets: [{
          data: statusData.data,
          backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#ef4444'],
          borderWidth: 0,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } },
        layout: { padding: 10 }
      }
    });

    // Priority Chart (Doughnut)
    if (priorityChart) priorityChart.destroy();
    priorityChart = new Chart(document.getElementById('priorityChart'), {
      type: 'doughnut',
      data: {
        labels: priorityData.labels,
        datasets: [{
          data: priorityData.data,
          backgroundColor: ['#ef4444', '#3b82f6', '#a855f7', '#10b981'], // High, Med, Low...
          borderWidth: 0,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } }
      }
    });

    // Trend Chart (Bar)
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(document.getElementById('trendChart'), {
      type: 'bar',
      data: {
        labels: trendData.labels,
        datasets: [{
          label: 'Tasks',
          data: trendData.data,
          backgroundColor: '#6366f1',
          borderRadius: 6,
          barThickness: 20
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { borderDash: [2, 4], color: 'rgba(0,0,0,0.05)' } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  function renderTopTasks(tasks) {
    const list = document.getElementById('top-tasks-list');
    list.innerHTML = '';

    if (!tasks || tasks.length === 0) {
      list.innerHTML = '<div class="text-center text-muted py-3">No urgent tasks found! ðŸŽ‰</div>';
      return;
    }

    tasks.forEach(task => {
      list.innerHTML += `
        <div class="list-item-glass d-flex justify-content-between align-items-center p-3">
          <div class="d-flex align-items-center gap-3">
             <div class="icon-box-sm bg-danger text-white rounded-circle d-flex align-items-center justify-content-center" style="width:32px;height:32px;">
                <i class="bi bi-exclamation"></i>
             </div>
             <div>
               <div class="fw-semibold">${task.title}</div>
               <div class="small text-muted"><i class="bi bi-calendar"></i> Due: ${task.due_date_formatted}</div>
             </div>
          </div>
          <span class="badge-glass bg-high">High Priority</span>
        </div>
      `;
    });
  }

  function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function animateValue(id, value) {
    const obj = document.getElementById(id);
    if (!obj) return;
    // Simple update for now, can add counter animation later
    obj.innerText = value;
  }

  // Init
  document.getElementById('date-filter').addEventListener('change', fetchAndRenderData);
  fetchAndRenderData();
</script>