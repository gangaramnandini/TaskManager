<%- include('partials/header') %>
<div class="container-fluid py-4" style="background:#f6f8fa;">
  <h2 class="fw-bold mb-1 ps-1" style="font-size: 2rem;">Task Analytics</h2>
  <div class="text-muted px-1 mb-4" style="font-size: 1rem;">Last updated: <span id="last-updated">just now</span></div>

  <!-- Filters Row -->
  <div class="card mb-4 p-3 shadow-sm rounded-4 border-0 d-flex flex-wrap align-items-center gap-3">
    <div>
      <label class="fw-semibold mb-0 me-2">Date Range:</label>
      <select id="date-filter" class="form-select d-inline-block w-auto">
        <option value="week">Last 7 Days</option>
        <option value="month">Last 30 Days</option>
        <option value="all" selected>All Time</option>
      </select>
    </div>
    <!-- Add more filters here if desired -->
  </div>

  <!-- Stats Row -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card p-3 rounded-4 shadow-sm border-0 text-center stat-card">
        <div class="text-muted small">Total Tasks</div>
        <div class="fw-bold fs-4 mb-1" id="stat-total">—</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card p-3 rounded-4 shadow-sm border-0 text-center stat-card">
        <div class="text-muted small">Completed</div>
        <div class="fw-bold fs-4 mb-1" id="stat-completed">—</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card p-3 rounded-4 shadow-sm border-0 text-center stat-card">
        <div class="text-muted small">Pending</div>
        <div class="fw-bold fs-4 mb-1" id="stat-pending">—</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card p-3 rounded-4 shadow-sm border-0 text-center stat-card">
        <div class="text-muted small">Upcoming</div>
        <div class="fw-bold fs-4 mb-1" id="stat-upcoming">—</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card p-3 rounded-4 shadow-sm border-0 text-center stat-card">
        <div class="text-muted small">Completion Rate</div>
        <div class="fw-bold fs-4 mb-1" id="stat-completion-rate">—</div>
      </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card p-3 rounded-4 shadow-sm border-0 text-center stat-card">
        <div class="text-muted small">Avg. Task Duration</div>
        <div class="fw-bold fs-4 mb-1" id="stat-avg-duration">—</div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-4 mb-4">
    <div class="col-lg-4">
      <div class="card rounded-4 shadow-sm p-3 mb-3 text-center">
        <h5>Task Status Distribution</h5>
        <canvas id="statusChart" height="160"></canvas>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card rounded-4 shadow-sm p-3 mb-3 text-center">
        <h5>Priority Breakdown</h5>
        <canvas id="priorityChart" height="160"></canvas>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card rounded-4 shadow-sm p-3 mb-3 text-center">
        <h5>Tasks Over Time (Weekly)</h5>
        <canvas id="trendChart" height="160"></canvas>
      </div>
    </div>
  </div>

  <!-- Top Priority Tasks (placeholder, can populate by server or AJAX)-->
  <div class="card rounded-4 shadow-sm p-3 mb-4">
    <h5 class="mb-3">Top Priority Tasks</h5>
    <ul id="top-tasks-list" class="list-group list-group-flush"></ul>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }

let statusChart, priorityChart, trendChart;

async function fetchAndRenderData() {
  const filter = document.getElementById('date-filter').value;
  document.getElementById('last-updated').innerText = new Date().toLocaleString();

  const res = await fetch(`/analytics/data?filter=${filter}`);
  if (!res.ok) { alert('Failed to load analytics data'); return; }
  const data = await res.json();

  // Stats counts
  let total = 0, completed = 0, pending = 0, upcoming = 0;
  data.statusData.forEach(s => {
    total += s.count;
    if (s.status === 'completed') completed = s.count;
    if (s.status === 'pending') pending = s.count;
    if (s.status === 'upcoming') upcoming = s.count;
  });
  document.getElementById('stat-total').innerText = total;
  document.getElementById('stat-completed').innerText = completed;
  document.getElementById('stat-pending').innerText = pending;
  document.getElementById('stat-upcoming').innerText = upcoming;
  document.getElementById('stat-completion-rate').innerText = total ? Math.round(completed / total * 100) + '%' : '-';
  // Optionally, set avg duration if available from backend
  document.getElementById('stat-avg-duration').innerText = data.avgTaskDuration || '—';

  // Charts
  const statusLabels = data.statusData.map(i => capitalize(i.status || 'Unknown'));
  const statusCounts = data.statusData.map(i => i.count);
  const statusColors = ['#198754', '#ffc107', '#0d6efd', '#dc3545'];

  const priorityLabels = data.priorityData.map(i => capitalize(i.priority || 'Unknown'));
  const priorityCounts = data.priorityData.map(i => i.count);
  const priorityColors = ['#dc3545', '#0dcaf0', '#6f42c1', '#198754'];

  const trendLabels = data.trendData.labels;
  const trendCounts = data.trendData.data;

  if(statusChart) statusChart.destroy();
  if(priorityChart) priorityChart.destroy();
  if(trendChart) trendChart.destroy();

  statusChart = new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: { labels: statusLabels, datasets: [{ data: statusCounts, backgroundColor: statusColors }] },
    options: { responsive: true, cutout: '65%' }
  });
  priorityChart = new Chart(document.getElementById('priorityChart'), {
    type: 'doughnut',
    data: { labels: priorityLabels, datasets: [{ data: priorityCounts, backgroundColor: priorityColors }] },
    options: { responsive: true, cutout: '65%' }
  });
  trendChart = new Chart(document.getElementById('trendChart'), {
    type: 'bar',
    data: { labels: trendLabels, datasets: [{ label: 'Tasks', data: trendCounts, backgroundColor: '#0d6efd', borderRadius: 8 }] },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Week' } },
        y: { beginAtZero: true, title: { display: true, text: 'Number of Tasks' } }
      }
    }
  });

  // Optionally render Top Priority Tasks (if provided by backend)
  const topTasksList = document.getElementById('top-tasks-list');
  topTasksList.innerHTML = '';
  if (data.topPriorityTasks && data.topPriorityTasks.length) {
    data.topPriorityTasks.forEach(task => {
      const badge = `<span class="badge bg-danger ms-2">High</span>`;
      topTasksList.innerHTML += `
        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0 py-2">
          <span>${task.title}</span>
          <span class="text-muted small">Due: ${task.due_date}</span>
          ${badge}
        </li>
      `;
    });
  }
}

document.getElementById('date-filter').addEventListener('change', fetchAndRenderData);

fetchAndRenderData();
</script>
