<%- include('partials/header') %>

<style>
.detail-container {
    max-width: 820px;
    margin: 48px auto;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 4px 32px #ececec;
    padding: 36px 40px 30px 40px;
}
.section-title {
    font-size: 1.42em;
    font-weight: 700;
    margin-bottom: 2px;
}
.section-desc {
    font-size: 15px;
    color: #888;
    margin-bottom: 22px;
}

.row-fields {
    display: flex;
    flex-wrap: wrap;
    gap: 26px 18px;
    margin-bottom: 22px;
}
.row-fields .field-block {
    flex: 1 1 200px;
    max-width: 240px;
}
.field-label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #5b5b77;
}
.field-content {
    background: #f6f7fb;
    border: 1px solid #e7eaf2;
    padding: 8px 12px;
    font-size: 15px;
    border-radius: 6px;
    color: #252738;
}

.subtasks-section {
    margin-top: 48px;
}
.subtasks-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.subtasks-title {
    font-size: 1.2em;
    font-weight: 700;
}
.add-subtask-btn {
    color: #4070fa;
    background: none;
    border: none;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    padding: 1px 10px;
    border-radius: 10px;
    transition: background 0.13s;
}
.add-subtask-btn:hover {
    background: #f2f6ff;
    text-decoration: underline;
}
.subtasks-list {
    margin-top: 18px;
    margin-bottom: 12px;
    background: #fafbfc;
    border-radius: 8px;
    box-shadow: 0 1px 8px #e3e8f36b;
    padding: 1px 0;
}
.subtask-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 14px;
    border-bottom: 1px solid #ececff;
}
.subtask-row:last-child { border-bottom: none; }

.subtask-left {
    display: flex;
    align-items: center;
}
.subtask-checkbox {
    width: 18px;
    height: 18px;
    accent-color: #4070fa;
    margin-right: 18px;
}
.subtask-title {
    font-size: 16px;
    color: #353545;
    font-weight: 500;
    user-select: text;
}
.subtask-title.completed {
    text-decoration: line-through;
    color: #b3b3cb;
}
.subtask-actions {
    display: flex;
    gap: 10px;
    opacity: 0.6;
}
.subtask-actions button {
    background: none;
    border: none;
    outline: none;
    font-size: 17px;
    cursor: pointer;
    padding: 0 4px;
    border-radius: 6px;
    transition: background 0.10s;
}
.subtask-actions button:hover {
    background: #f2f2fa;
    opacity: 1;
}
.add-form-row {
    display: flex;
    gap: 10px;
    padding: 14px 0;
    align-items: center;
}
.add-form-row input[type=text] {
    flex: 1 1 200px;
    padding: 6px 12px;
    border: 1px solid #dbe3ea;
    border-radius: 6px;
    font-size: 15px;
}
.add-form-row button {
    padding: 7px 16px;
    font-size: 15px;
    border: none;
    border-radius: 7px;
    font-weight: 600;
    cursor: pointer;
}
.add-form-row .add-btn {
    background: #4070fa;
    color: #fff;
    margin-right: 4px;
}
.add-form-row .cancel-btn {
    background: #f5f5f7;
    color: #353545;
}

@media (max-width:600px){
    .detail-container {padding:24px 2vw;}
    .row-fields {flex-direction:column;}
}
/* comments */
.comments-section {
    max-width: 820px;
    margin: 30px auto 0 auto;   /* Centers horizontally */
    background: #fff;
    border-radius: 13px;
    box-shadow: 0 2px 14px #ececec;
    padding: 30px 32px 24px 32px;
}

.comments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.comments-title {
    font-weight: 700;
    font-size: 1.14rem;
    color: #222;
}
.add-comment-btn {
    color: #4078fa;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    padding: 12px 18px;
    user-select: none;
}
.comments-list {
    margin-top: 20px;
}
.comment-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 20px;
    border-radius: 12px;
    box-shadow: 0 1px 8px #e3e8f36b;
    margin-bottom: 12px;
    background: #f1f3fe;
}
.comment-left {
    font-size: 16px;
    font-weight: 600;
    color: #353545;
    flex-grow: 1;
}
.comment-actions button {
    background: none;
    border: none;
    font-size: 18px;
    color: #656585;
    cursor: pointer;
    margin-left: 12px;
    border-radius: 8px;
    padding: 4px 10px;
    user-select: none;
}
.comment-actions button:hover {
    color: #2e61e2;
    background: #ebf0fa;
}
.add-form-row {
    margin-top: 16px;
    display: flex;
    gap: 12px;
    align-items: center;
}
#commentInput {
    flex-grow: 1;
    border-radius: 12px;
    border: 1px solid #d8d8ee;
    padding: 14px 24px;
    font-size: 16px;
    font-weight: 600;
}
.add-btn, .cancel-btn {
    font-weight: 700;
    font-size: 16px;
    border-radius: 12px;
    border: none;
    padding: 12px 16px;
    cursor: pointer;
    user-select: none;
}
.add-btn {
    background: #4078fa;
    color: white;
}
.cancel-btn {
    background: #e4e4e4;
}
.cancel-btn:hover {
    background: #cbcbcb;
}
</style>

<div class="detail-container">
    <!-- Main Task Details -->
    <div>
        <div class="section-title">Task Details</div>
        <div class="section-desc">Enter the core information for your new task.</div>
        <div class="field-label">Task Title</div>
        <div class="field-content" style="margin-bottom:13px;"><%= task.title %></div>
        <div class="field-label">Description</div>
        <div class="field-content" style="margin-bottom:23px;"><%= task.description %></div>
        <div class="row-fields">
            <div class="field-block">
                <div class="field-label">Due Date</div>
                <div class="field-content"><%= task.due_date ? task.due_date.toISOString().split('T')[0] : 'N/A' %></div>
            </div>
            <div class="field-block">
                <div class="field-label">Priority</div>
                <div class="field-content"><%= task.priority %></div>
            </div>
            <div class="field-block">
                <div class="field-label">Status</div>
                <div class="field-content"><%= task.status %></div>
            </div>
        </div>
    </div>

    <!-- Subtasks -->
    <div class="subtasks-section">
        <div class="subtasks-header">
            <div class="subtasks-title">Subtasks</div>
            <button class="add-subtask-btn" id="showAddSubtask">+ Add Subtask</button>
        </div>
        <div style="color:#8c8c9e;font-size:14px;margin-bottom:5px;">Break down your task into smaller, manageable steps.</div>
        <div class="subtasks-list" id="subtasksList">
            <% subtasks.forEach(subtask => { %>
            <div class="subtask-row" data-id="<%= subtask.subtask_id %>">
                <div class="subtask-left">
                    <input type="checkbox" class="subtask-checkbox" <%= subtask.status === 'completed' ? 'checked' : '' %> >
                    <span class="subtask-title <%= subtask.status==='completed' ? 'completed' : '' %>"><%= subtask.title %></span>
                </div>
                <div class="subtask-actions">
                    <button class="edit-subtask" title="Edit">&#9998;</button>
                    <button class="delete-subtask" title="Delete">&#10006;</button>
                </div>
            </div>
            <% }) %>
        </div>
        <form id="addSubtaskForm" class="add-form-row" style="display:none;">
            <input type="text" id="subtaskTitleInput" placeholder="Enter subtask..." required>
            <button type="submit" class="add-btn">Add</button>
            <button type="button" class="cancel-btn" id="cancelAddSubtask">Cancel</button>
        </form>
    </div>
</div>


<!-- Comments -->
<div class="comments-section">
  <div class="comments-header">
      <div class="comments-title">Comments</div>
      <button class="add-comment-btn" id="showAddComment">+ Add Comment</button>
  </div>
  <div style="color:#8c8c9e;font-size:14px;margin-bottom:5px;">Add your thoughts or notes here.</div>
  <div class="comments-list" id="commentsList">
      <% comments.forEach(comment => { %>
      <div class="comment-row" data-id="<%= comment.comment_id %>">
          <div class="comment-left">
              <span class="comment-text"><%= comment.comment %></span>
          </div>
          <div class="comment-actions">
              <button class="edit-comment" title="Edit">&#9998;</button>
              <button class="delete-comment" title="Delete">&#10006;</button>
          </div>
      </div>
      <% }) %>
  </div>
  <form id="addCommentForm" class="add-form-row" style="display:none;">
      <input type="text" id="commentInput" placeholder="Enter comment..." required>
      <button type="submit" class="add-btn">Add</button>
      <button type="button" class="cancel-btn" id="cancelAddComment">Cancel</button>
  </form>
</div>


<script>

let editingSubtaskId = null;

// Show add subtask form
document.getElementById('showAddSubtask').onclick = function() {
    editingSubtaskId = null;
    const form = document.getElementById('addSubtaskForm');
    form.style.display = 'flex';
    form.reset && form.reset();
    document.getElementById('subtaskTitleInput').value = '';
    document.getElementById('subtaskTitleInput').focus();
};

// Cancel add subtask
document.getElementById('cancelAddSubtask').onclick = function() {
    document.getElementById('addSubtaskForm').style.display = 'none';
};

// Submit new subtask
document.getElementById('addSubtaskForm').onsubmit = async function(e) {
    e.preventDefault();
    if (!editingSubtaskId) {
        await fetch(`/tasks/<%= task.task_id %>/subtasks/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: document.getElementById('subtaskTitleInput').value.trim() })
        });
    } else { // Optional: edit mode
        await fetch(`/subtasks/${editingSubtaskId}/edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: document.getElementById('subtaskTitleInput').value.trim() })
        });
    }
    document.getElementById('addSubtaskForm').style.display = 'none';
    editingSubtaskId = null;
    await refreshSubtasks();
};

// Subtask actions: mark as done, delete, edit
document.getElementById('subtasksList').onclick = async function(e) {
    const row = e.target.closest('.subtask-row');
    if (!row) return;
    const subtaskId = row.dataset.id;

    // Toggle done
    if (e.target.classList.contains('subtask-checkbox')) {
        await fetch(`/subtasks/${subtaskId}/toggle`, { method: 'POST' });
        await refreshSubtasks();
    }
    // Delete
    if (e.target.classList.contains('delete-subtask')) {
        if (confirm('Delete this subtask?')) {
            await fetch(`/subtasks/${subtaskId}/delete`, { method: 'POST' });
            await refreshSubtasks();
        }
    }
    // Edit
    if (e.target.classList.contains('edit-subtask')) {
        editingSubtaskId = subtaskId;
        document.getElementById('addSubtaskForm').style.display = 'flex';
        document.getElementById('subtaskTitleInput').value = row.querySelector('.subtask-title').textContent.trim();
        document.getElementById('subtaskTitleInput').focus();
        document.querySelector('.add-btn').textContent = 'Update';
    }
};

// Refresh subtasks after any change
async function refreshSubtasks() {
    const res = await fetch(`/tasks/<%= task.task_id %>/subtasks/list`);
    const subtasks = await res.json();
    const list = document.getElementById('subtasksList');
    list.innerHTML = subtasks.map(sub => `
        <div class="subtask-row" data-id="${sub.subtask_id}">
            <div class="subtask-left">
                <input type="checkbox" class="subtask-checkbox" ${sub.status === 'completed' ? 'checked' : ''}>
                <span class="subtask-title ${sub.status === 'completed' ? 'completed' : ''}">${sub.title}</span>
            </div>
            <div class="subtask-actions">
                <button class="edit-subtask" title="Edit">&#9998;</button>
                <button class="delete-subtask" title="Delete">&#10006;</button>
            </div>
        </div>
    `).join('');
}

//commnets
document.addEventListener('DOMContentLoaded', function() {
    const showAddCommentBtn = document.getElementById('showAddComment');
    const addCommentForm = document.getElementById('addCommentForm');
    const cancelAddCommentBtn = document.getElementById('cancelAddComment');
    const commentInput = document.getElementById('commentInput');
    const commentsList = document.getElementById('commentsList');
    let editingId = null;

    showAddCommentBtn.addEventListener('click', () => {
        addCommentForm.style.display = 'flex';
        commentInput.focus();
        showAddCommentBtn.style.display = 'none';
    });

    cancelAddCommentBtn.addEventListener('click', () => {
        addCommentForm.style.display = 'none';
        commentInput.value = '';
        editingId = null;
        showAddCommentBtn.style.display = 'inline-block';
    });

    addCommentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const commentText = commentInput.value.trim();
        if (!commentText) return;
        const url = editingId
            ? `/comments/${editingId}/edit`
            : `/tasks/<%= task.task_id %>/comments/add`;
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({comment: commentText}),
        });
        if (!res.ok) {
            alert(editingId ? 'Edit failed' : 'Add failed');
            return;
        }
        commentInput.value = '';
        addCommentForm.style.display = 'none';
        showAddCommentBtn.style.display = 'inline-block';
        editingId = null;
        refreshComments();
    });

    commentsList.addEventListener('click', async (e) => {
        const target = e.target;
        const commentRow = target.closest('.comment-row');
        if (!commentRow) return;
        const id = commentRow.dataset.id;

        if (target.classList.contains('edit-comment')) {
            const commentText = commentRow.querySelector('.comment-text').textContent;
            editingId = id;
            addCommentForm.style.display = 'flex';
            commentInput.value = commentText;
            commentInput.focus();
            showAddCommentBtn.style.display = 'none';
        }

        if (target.classList.contains('delete-comment')) {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            const res = await fetch(`/comments/${id}/delete`, {
                method: 'POST'
            });
            if (!res.ok) {
                return alert('Delete failed');
            }
            refreshComments();
        }
    });

    async function refreshComments() {
        const res = await fetch(`/tasks/<%= task.task_id %>/comments/list`);
        if (!res.ok) return alert('Failed to load comments');
        const comments = await res.json();
        commentsList.innerHTML = comments.map(comment => `
            <div class="comment-row" data-id="${comment.comment_id}">
                <div class="comment-left">
                    <span class="comment-text">${comment.comment}</span>
                </div>
                <div class="comment-actions">
                    <button class="edit-comment" title="Edit">&#9998;</button>
                    <button class="delete-comment" title="Delete">&#10006;</button>
                </div>
            </div>
        `).join('');
    }
});
</script>
    <%- include('partials/footer') %>